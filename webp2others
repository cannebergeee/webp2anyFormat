import os
import shutil
import threading
import tkinter as tk
import platform  # æ–°å¢žï¼šç”¨äºŽåˆ¤æ–­æ“ä½œç³»ç»Ÿ
import subprocess # æ–°å¢žï¼šç”¨äºŽåœ¨Mac/Linuxæ‰§è¡Œå‘½ä»¤
from tkinter import filedialog, messagebox, scrolledtext

# --- 0. æ ¸å¿ƒä¾èµ–æ£€æŸ¥ (Pillow) ---
try:
    from PIL import Image, ImageTk, ImageSequence
except ImportError:
    # Macä¸‹é€šå¸¸ä½¿ç”¨ pip3
    messagebox.showerror("ç¼ºå°‘ä¾èµ–", "è¯·å®‰è£… Pillow åº“:\npip3 install Pillow")
    exit()

# --- 1. UI ç¾ŽåŒ–åº“ (ttkbootstrap) ---
try:
    import ttkbootstrap as ttk
    from ttkbootstrap.constants import *
    HAS_BOOTSTRAP = True
except ImportError:
    import tkinter.ttk as ttk
    HAS_BOOTSTRAP = False

# --- 2. OpenCV (è§†é¢‘å¤„ç†) ---
try:
    import cv2
    import numpy as np
    HAS_OPENCV = True
except ImportError:
    HAS_OPENCV = False

class WebPConverterApp:
    def __init__(self, root):
        self.root = root
        self.root.title("WebP æ ¼å¼å·¥åŽ‚ (macOSç‰ˆ)")
        self.root.geometry("950x650")
        
        # --- macOS Retina å±å¹•é€‚é…å°è¯• ---
        # å¦‚æžœåœ¨é«˜åˆ†å±ä¸Šå­—ä½“æ¨¡ç³Šï¼Œå¯ä»¥å°è¯•å¯ç”¨è¿™è¡Œä»£ç ï¼Œæˆ–è€…è°ƒæ•´ç¼©æ”¾å› å­
        # try:
        #     self.root.tk.call('tk', 'scaling', 2.0)
        # except:
        #     pass

        # åº”ç”¨ä¸»é¢˜
        if HAS_BOOTSTRAP:
            # "cosmo" ä¸»é¢˜åœ¨ Mac ä¸Šé€šå¸¸è¡¨çŽ°è¾ƒå¥½
            self.style = ttk.Style(theme="cosmo") 

        # --- å˜é‡åˆå§‹åŒ– ---
        self.vars = {
            "batch_path": tk.StringVar(),
            "file_list": [],
            "opt_gif": tk.BooleanVar(value=True),
            "opt_mp4": tk.BooleanVar(value=False),
            "opt_png": tk.BooleanVar(value=True),
            "opt_backup": tk.BooleanVar(value=True),
            "progress_val": tk.DoubleVar(value=0),
            "status_text": tk.StringVar(value="å‡†å¤‡å°±ç»ª")
        }
        self.current_output_folder = ""
        self.system_os = platform.system() # èŽ·å–ç³»ç»Ÿç±»åž‹ (Windows/Darwin/Linux)

        self.setup_ui()
        self.log(f"âœ… ç¨‹åºå¯åŠ¨æˆåŠŸ (å½“å‰ç³»ç»Ÿ: {self.system_os})")
        self.log("â„¹ï¸ è¯·ä½¿ç”¨â€œæµè§ˆâ€æˆ–â€œæ·»åŠ æ–‡ä»¶â€æŒ‰é’®é€‰æ‹©å›¾ç‰‡")

    def setup_ui(self):
        # ================== ä¸»å¸ƒå±€å®¹å™¨ ==================
        sidebar = ttk.Frame(self.root, padding=10, width=250)
        sidebar.pack(side="left", fill="y")
        
        ttk.Separator(self.root, orient="vertical").pack(side="left", fill="y", padx=2)

        content = ttk.Frame(self.root, padding=10)
        content.pack(side="right", fill="both", expand=True)

        # ================== 1. å·¦ä¾§ä¾§è¾¹æ  ==================
        
        # Macå­—ä½“é€‚é…ï¼šä¼˜å…ˆå°è¯• Mac åŽŸç”Ÿå­—ä½“ï¼Œæ²¡æœ‰åˆ™å›žé€€
        title_font = ("PingFang SC", 14, "bold") if self.system_os == "Darwin" else ("å¾®è½¯é›…é»‘", 14, "bold")
        normal_font = ("PingFang SC", 10) if self.system_os == "Darwin" else ("å¾®è½¯é›…é»‘", 9)
        
        lbl_title = ttk.Label(sidebar, text="âš™ï¸ è®¾ç½®é¢æ¿", font=title_font, bootstyle="primary")
        lbl_title.pack(anchor="w", pady=(0, 20))

        # 1.2 è½¬æ¢é€‰é¡¹
        opt_group = ttk.Labelframe(sidebar, text="è½¬æ¢ç›®æ ‡æ ¼å¼", padding=10, bootstyle="info")
        opt_group.pack(fill="x", pady=(0, 20))

        chk_style = "round-toggle" if HAS_BOOTSTRAP else ""
        
        ttk.Checkbutton(opt_group, text="GIF åŠ¨å›¾", variable=self.vars["opt_gif"], bootstyle=f"success-{chk_style}").pack(anchor="w", pady=5)
        
        mp4_text = "MP4 è§†é¢‘" if HAS_OPENCV else "MP4 (æœªå®‰è£…OpenCV)"
        mp4_state = "normal" if HAS_OPENCV else "disabled"
        ttk.Checkbutton(opt_group, text=mp4_text, variable=self.vars["opt_mp4"], state=mp4_state, bootstyle=f"primary-{chk_style}").pack(anchor="w", pady=5)
        
        ttk.Checkbutton(opt_group, text="PNG åºåˆ—/å›¾ç‰‡", variable=self.vars["opt_png"], bootstyle=f"warning-{chk_style}").pack(anchor="w", pady=5)
        
        ttk.Separator(opt_group, orient="horizontal").pack(fill="x", pady=10)
        ttk.Checkbutton(opt_group, text="ä¿ç•™æºæ–‡ä»¶å¤‡ä»½", variable=self.vars["opt_backup"], bootstyle=f"secondary-{chk_style}").pack(anchor="w", pady=5)

        # 1.3 è¿›åº¦æ¡
        progress_group = ttk.Labelframe(sidebar, text="æ‰§è¡Œè¿›åº¦", padding=10)
        progress_group.pack(fill="x", pady=(0, 20))
        
        self.progressbar = ttk.Progressbar(progress_group, variable=self.vars["progress_val"], maximum=100, bootstyle="success-striped")
        self.progressbar.pack(fill="x", pady=(0, 5))
        
        ttk.Label(progress_group, textvariable=self.vars["status_text"], font=normal_font, foreground="#555", wraplength=200).pack(anchor="w")

        # 1.4 æ—¥å¿—
        log_group = ttk.Labelframe(sidebar, text="ç³»ç»Ÿæ—¥å¿—", padding=5)
        log_group.pack(fill="both", expand=True, pady=(0, 20))
        
        # Macä¸Šçš„ Consolas å¯èƒ½ä¸å¯ç”¨ï¼Œæ”¹ä¸º Menlo æˆ– Monaco
        log_font = ("Menlo", 10) if self.system_os == "Darwin" else ("Consolas", 8)
        self.txt_log = scrolledtext.ScrolledText(log_group, width=25, height=5, state='disabled', 
                                                 font=log_font, relief="flat", bg="#f4f6f9")
        self.txt_log.pack(fill="both", expand=True)

        # 1.5 åº•éƒ¨å¤§æŒ‰é’®
        self.btn_open = ttk.Button(sidebar, text="ðŸ“‚ æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹", command=self.open_output_folder, state="disabled", bootstyle="outline-primary")
        self.btn_open.pack(fill="x", pady=5)

        # ================== 2. å³ä¾§å†…å®¹åŒº ==================
        
        self.notebook = ttk.Notebook(content, bootstyle="default")
        self.notebook.pack(expand=True, fill="both")

        self.tab_batch = ttk.Frame(self.notebook, padding=30)
        self.tab_multi = ttk.Frame(self.notebook, padding=20)
        
        self.notebook.add(self.tab_batch, text=" ðŸ“‚ æ–‡ä»¶å¤¹æ‰¹é‡æ¨¡å¼ ")
        self.notebook.add(self.tab_multi, text=" ðŸ“„ å¤šæ–‡ä»¶åˆ—è¡¨æ¨¡å¼ ")

        self.setup_batch_ui(self.tab_batch)
        self.setup_multi_ui(self.tab_multi)

    def setup_batch_ui(self, parent):
        ui_font = ("PingFang SC", 10) if self.system_os == "Darwin" else ("å¾®è½¯é›…é»‘", 10)
        header_font = ("PingFang SC", 16, "bold") if self.system_os == "Darwin" else ("å¾®è½¯é›…é»‘", 16, "bold")

        card = ttk.Frame(parent)
        card.place(relx=0.5, rely=0.4, anchor="center", relwidth=0.9)
        
        ttk.Label(card, text="æ‰¹é‡å¤„ç†æ–‡ä»¶å¤¹", font=header_font, foreground="#333").pack(pady=(0,20))
        ttk.Label(card, text="è¯·é€‰æ‹©åŒ…å« .webp æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œç¨‹åºå°†è‡ªåŠ¨å¤„ç†æ‰€æœ‰å›¾ç‰‡ã€‚", font=ui_font, foreground="#666").pack(pady=(0,30))
        
        input_group = ttk.Frame(card)
        input_group.pack(fill="x", padx=20)
        
        ttk.Entry(input_group, textvariable=self.vars["batch_path"], font=ui_font).pack(side="left", fill="x", expand=True, padx=(0, 10))
        ttk.Button(input_group, text="æµè§ˆæ–‡ä»¶å¤¹...", command=self.select_batch_folder, bootstyle="secondary").pack(side="right")
        
        ttk.Button(card, text="ðŸš€ å¼€å§‹æ‰¹é‡è½¬æ¢", command=lambda: self.start_thread("batch"), 
                   bootstyle="success", width=30).pack(pady=40)

    def setup_multi_ui(self, parent):
        list_font = ("PingFang SC", 11) if self.system_os == "Darwin" else ("å¾®è½¯é›…é»‘", 10)

        top_bar = ttk.Frame(parent)
        top_bar.pack(fill="x", pady=(0, 10))
        
        ttk.Button(top_bar, text="âž• æ·»åŠ  WebP æ–‡ä»¶", command=self.select_multi_files, bootstyle="primary").pack(side="left")
        ttk.Button(top_bar, text="ðŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨", command=self.clear_file_list, bootstyle="danger-outline").pack(side="right")
        
        # åˆ—è¡¨åŒºåŸŸ
        list_frame = ttk.Frame(parent, padding=1, bootstyle="secondary")
        list_frame.pack(fill="both", expand=True)
        
        self.lst_files = tk.Listbox(list_frame, selectmode="extended", 
                                    relief="flat", highlightthickness=0, font=list_font, bg="#ffffff")
        self.lst_files.pack(fill="both", expand=True, padx=1, pady=1)
        
        ttk.Button(parent, text="ðŸš€ å¼€å§‹åˆ—è¡¨è½¬æ¢", command=lambda: self.start_thread("multi"), 
                   bootstyle="primary", width=30).pack(pady=15)

    # --- é€»è¾‘åŠŸèƒ½ ---

    def log(self, message):
        self.txt_log.config(state='normal')
        self.txt_log.insert(tk.END, message + "\n")
        self.txt_log.see(tk.END)
        self.txt_log.config(state='disabled')

    def update_status(self, text, progress=None):
        self.vars["status_text"].set(text)
        if progress is not None:
            self.vars["progress_val"].set(progress)
        self.root.update_idletasks()

    def select_batch_folder(self):
        path = filedialog.askdirectory()
        if path: self.vars["batch_path"].set(path)

    def select_multi_files(self):
        files = filedialog.askopenfilenames(filetypes=[("WebP Image", "*.webp")])
        if files:
            for f in files:
                if f not in self.vars["file_list"]:
                    self.vars["file_list"].append(f)
                    self.lst_files.insert(tk.END, f)
            self.notebook.select(self.tab_multi)

    def clear_file_list(self):
        self.vars["file_list"] = []
        self.lst_files.delete(0, tk.END)

    def start_thread(self, mode):
        tasks = []
        if mode == "batch":
            folder = self.vars["batch_path"].get()
            if not folder or not os.path.exists(folder):
                messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶å¤¹")
                return
            out_root = os.path.join(folder, "Output_Fixed")
            try:
                tasks = [{"src": os.path.join(folder, f), "root": out_root} 
                        for f in os.listdir(folder) if f.lower().endswith('.webp')]
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯»å–æ–‡ä»¶å¤¹å¤±è´¥: {e}")
                return

        elif mode == "multi":
            files = self.vars["file_list"]
            if not files:
                messagebox.showerror("é”™è¯¯", "åˆ—è¡¨ä¸ºç©º")
                return
            out_root = os.path.join(os.path.dirname(files[0]), "Output_Fixed")
            tasks = [{"src": f, "root": out_root} for f in files]

        if not tasks:
            self.log("âš ï¸ æ²¡æœ‰æ‰¾åˆ° .webp æ–‡ä»¶")
            return

        self.current_output_folder = out_root
        self.btn_open.config(state="disabled")
        threading.Thread(target=self.process_tasks, args=(tasks,)).start()

    def process_tasks(self, tasks):
        total = len(tasks)
        if not os.path.exists(self.current_output_folder):
            os.makedirs(self.current_output_folder)

        self.log(f"ðŸš€ å¼€å§‹å¤„ç† {total} ä¸ªä»»åŠ¡...")
        self.update_status(f"åˆå§‹åŒ–...", 0)

        do_gif = self.vars["opt_gif"].get()
        do_mp4 = self.vars["opt_mp4"].get() and HAS_OPENCV
        do_png = self.vars["opt_png"].get()
        do_backup = self.vars["opt_backup"].get()

        for i, task in enumerate(tasks):
            src = task["src"]
            root = task["root"]
            fname = os.path.basename(src)
            name_no_ext = os.path.splitext(fname)[0]
            
            progress_percent = ((i) / total) * 100
            self.update_status(f"æ­£åœ¨å¤„ç†: {fname}", progress_percent)
            self.log(f"[{i+1}/{total}] {fname}")

            save_dir = os.path.join(root, name_no_ext)
            if not os.path.exists(save_dir): os.makedirs(save_dir)

            try:
                with Image.open(src) as im:
                    frames = []
                    try:
                        while True:
                            frames.append(im.convert("RGBA").copy())
                            im.seek(im.tell() + 1)
                    except EOFError: pass
                    
                    is_anim = len(frames) > 1
                    duration = im.info.get('duration', 100)
                    if duration <= 0: duration = 100 

                    # 1. å¤‡ä»½
                    if do_backup:
                        shutil.copy2(src, os.path.join(save_dir, fname))

                    # 2. è½¬ GIF
                    if do_gif and is_anim:
                        gif_path = os.path.join(save_dir, f"{name_no_ext}.gif")
                        frames[0].save(gif_path, save_all=True, append_images=frames[1:],
                                       optimize=False, duration=duration, loop=0, disposal=2)

                    # 3. è½¬ MP4 (éœ€è¦ OpenCV)
                    if do_mp4 and is_anim and HAS_OPENCV:
                        try:
                            mp4_path = os.path.join(save_dir, f"{name_no_ext}.mp4")
                            h, w = frames[0].size[1], frames[0].size[0]
                            fps = 1000.0 / max(duration, 20)
                            # MacOSä¸‹ mp4v é€šå¸¸å¯ç”¨ï¼Œä½†ä¹Ÿå¯èƒ½éœ€è¦ avc1ã€‚è¿™é‡Œä¿æŒ mp4v å…¼å®¹æ€§è¾ƒé«˜ã€‚
                            video = cv2.VideoWriter(mp4_path, cv2.VideoWriter_fourcc(*'mp4v'), 
                                                    fps, (w, h))
                            for f in frames:
                                img_np = np.array(f)
                                img_bgr = cv2.cvtColor(img_np, cv2.COLOR_RGBA2BGR)
                                video.write(img_bgr)
                            video.release()
                        except Exception as e_mp4:
                            self.log(f"  â””â”€ MP4å¤±è´¥: {e_mp4}")

                    # 4. è½¬ PNG
                    if do_png:
                        if is_anim:
                            for idx, f in enumerate(frames):
                                f.save(os.path.join(save_dir, f"frame_{idx:03d}.png"))
                        else:
                            frames[0].save(os.path.join(save_dir, f"{name_no_ext}.png"))

            except Exception as e:
                self.log(f"âŒ æ–‡ä»¶é”™è¯¯: {e}")

        self.update_status("âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ", 100)
        self.log("\nâœ¨ å…¨éƒ¨è½¬æ¢ç»“æŸï¼")
        
        # è¿™é‡Œçš„ lambda é˜²æ­¢ç•Œé¢å¡æ­»ï¼Œä½¿ç”¨ after è°ƒåº¦
        self.root.after(0, lambda: self.btn_open.config(state="normal", bootstyle="primary"))
        self.root.after(0, lambda: messagebox.showinfo("å®Œæˆ", f"å·²å¤„ç† {total} ä¸ªæ–‡ä»¶"))

    # ================= å…¼å®¹æ€§ä¿®æ”¹çš„æ ¸å¿ƒéƒ¨åˆ† =================
    def open_output_folder(self):
        """è·¨å¹³å°æ‰“å¼€æ–‡ä»¶å¤¹é€»è¾‘"""
        path = self.current_output_folder
        if not os.path.exists(path):
            return

        try:
            if self.system_os == "Windows":
                os.startfile(path)
            elif self.system_os == "Darwin":  # macOS
                subprocess.call(["open", path])
            else:  # Linux (Ubuntu/Debianç­‰)
                subprocess.call(["xdg-open", path])
        except Exception as e:
            self.log(f"âŒ æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹: {e}")
            messagebox.showwarning("æç¤º", f"å·²å®Œæˆï¼Œä½†æ— æ³•è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶å¤¹ã€‚\nè·¯å¾„ï¼š{path}")

if __name__ == "__main__":
    root = tk.Tk()
    app = WebPConverterApp(root)
    root.mainloop()
